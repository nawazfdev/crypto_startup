"use strict";(function(){if(typeof jQuery==='undefined'){console.error("jQuery is not available. Waiting for it to load...");var script=document.createElement('script');script.src='https://code.jquery.com/jquery-3.6.0.min.js';script.integrity='sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=';script.crossOrigin='anonymous';document.head.appendChild(script);}
if(typeof jQuery!=='undefined'&&typeof $==='undefined'){window.$=window.jQuery;}})();var Post={draftData:{text:"",attachments:[]},activePage:'post',postID:null,commentID:null,setActivePage:function(page){Post.activePage=page;},initPostsMediaModule:function(){return new Swiper(".post-box .mySwiper",{slidesPerView:'auto',pagination:{el:".swiper-pagination",dynamicBullets:true,},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev",},});},initGalleryModule:function(gallerySelector=false){mswpScanPage(gallerySelector,'mswp');},addComment:function(postID){let postElement=$('*[data-postID="'+postID+'"]');let newCommentButton=postElement.find('.new-post-comment-area').find('button');updateButtonState('loading',newCommentButton);$.ajax({type:'POST',data:{'message':postElement.find('.new-comment-textarea').val(),'post_id':postID},url:app.baseUrl+'/posts/comments/add',success:function(result){if(result.success){launchToast('success',trans('Success'),trans('Comment added'));postElement.find('.no-comments-label').addClass('d-none');postElement.find('.post-comments-wrapper').prepend(result.data).fadeIn('slow');postElement.find('.new-comment-textarea').val('');const commentsCount=parseInt(postElement.find('.post-comments-label-count').html())+1;postElement.find('.post-comments-label-count').html(commentsCount);postElement.find('.post-comments-label').html(trans_choice('comments',commentsCount));updateButtonState('loaded',newCommentButton);}
else{launchToast('danger',trans('Error'),result.errors[0]);updateButtonState('loaded',newCommentButton);}
newCommentButton.blur();},error:function(result){postElement.find('.new-comment-textarea').addClass('is-invalid');if(result.status===422){$.each(result.responseJSON.errors,function(field,error){if(field==='message'){postElement.find('.new-comment-textarea').parent().find('.invalid-feedback').html(error);}});updateButtonState('loaded',newCommentButton);}
else if(result.status===403||result.status===404){launchToast('danger',trans('Error'),result.responseJSON.message);}
newCommentButton.blur();}});},showDeleteCommentDialog:function(postID,commentID){showDialog('comment-delete-dialog');Post.commentID=commentID;Post.postID=postID;},deleteComment:function(){let commentElement=$('*[data-commentID="'+Post.commentID+'"]');let postElement=$('*[data-postID="'+Post.postID+'"]');$.ajax({type:'DELETE',data:{'id':Post.commentID},dataType:'json',url:app.baseUrl+'/posts/comments/delete',success:function(result){if(result.success){commentElement.fadeOut("normal",function(){$(this).remove();if(postElement.find('.post-comment').length===0){postElement.find('.no-comments-label').removeClass('d-none');}});const commentsCount=parseInt(postElement.find('.post-comments-label-count').html())-1;postElement.find('.post-comments-label-count').html(commentsCount);postElement.find('.post-comments-label').html(trans_choice('comments',commentsCount));launchToast('success',trans('Success'),result.message);hideDialog('comment-delete-dialog');}
else{launchToast('danger',trans('Error'),result.errors[0]);$('#comment-delete-dialog').modal('hide');}},error:function(result){launchToast('danger',trans('Error'),result.responseJSON.message);hideDialog('comment-delete-dialog');}});},showPostComments:function(post_id){let postElement=$('*[data-postID="'+post_id+'"] .post-comments');if(typeof postVars==='undefined'){CommentsPaginator.nextPageUrl='';}
if(CommentsPaginator.nextPageUrl===''){CommentsPaginator.init(app.baseUrl+'/posts/comments',postElement.find('.post-comments-wrapper'));}
const isHidden=postElement.hasClass('d-none');if(isHidden){if(!postElement.hasClass('latest-comments-loaded')){CommentsPaginator.loadResults(post_id,9);}
postElement.removeClass('d-none');postElement.addClass('latest-comments-loaded');}
else{postElement.addClass('d-none');}},reactTo:function(type,id){let reactElement=null;let reactionsCountLabel=null;let reactionsLabel=null;if(type==='post'){reactElement=$('*[data-postID="'+id+'"] .post-footer .react-button');reactionsCountLabel=$('*[data-postID="'+id+'"] .post-footer .post-reactions-label-count');reactionsLabel=$('*[data-postID="'+id+'"] .post-footer .post-reactions-label');}
else{reactElement=$('*[data-commentID="'+id+'"] .react-button');reactionsCountLabel=$('*[data-commentID="'+id+'"] .comment-reactions-label-count');reactionsLabel=$('*[data-commentID="'+id+'"] .comment-reactions-label');}
const didReact=reactElement.hasClass('active');if(didReact){reactElement.removeClass('active');reactElement.html(`<ion-icon name="heart-outline" class="icon-medium"></ion-icon>`);}
else{reactElement.addClass('active');reactElement.html(`<ion-icon name="heart" class="icon-medium text-primary"></ion-icon>`);}
$.ajax({type:'POST',data:{'type':type,'action':(didReact===true?'remove':'add'),'id':id},dataType:'json',url:app.baseUrl+'/posts/reaction',success:function(result){if(result.success){let count=parseInt(reactionsCountLabel.html());if(didReact){count--;}
else{count++;}
reactionsCountLabel.html(count);reactionsLabel.html(trans_choice('likes',count));}
else{launchToast('danger',trans('Error'),result.errors[0]);}},error:function(result){launchToast('danger',trans('Error'),result.responseJSON.message);}});},addReplyUser:function(username){$('.new-post-comment-area textarea').val($('.new-post-comment-area textarea').val()+' @'+username+' ');},confirmPostRemoval:function(post_id){Post.postID=post_id;$('#post-delete-dialog').modal('show');},removePost:function(){let postElement=$('*[data-postID="'+Post.postID+'"]');$.ajax({type:'DELETE',data:{'id':Post.postID},dataType:'json',url:app.baseUrl+'/posts/delete',success:function(result){if(result.success){if(Post.activePage!=='post'){$('#post-delete-dialog').modal('hide');postElement.fadeOut("normal",function(){$(this).remove();});}
else{if(document.referrer.indexOf('feed')>0){redirect(app.baseUrl+'/feed');}
else{redirect(document.referrer);}}
launchToast('success',trans('Success'),result.message);}
else{$('#post-delete-dialog').modal('hide');launchToast('danger',trans('Error'),result.errors[0]);}},error:function(result){launchToast('danger',trans('Error'),result.responseJSON.message);}});},togglePostBookmark:function(id){let reactElement=$('*[data-postID="'+id+'"] .bookmark-button');const isBookmarked=reactElement.hasClass('is-active');$.ajax({type:'POST',data:{'action':(isBookmarked===true?'remove':'add'),'id':id},dataType:'json',url:app.baseUrl+'/posts/bookmark',success:function(result){if(result.success){if(isBookmarked){reactElement.removeClass('is-active');reactElement.html(trans('Bookmark this post'));}
else{reactElement.addClass('is-active');reactElement.html(trans('Remove this bookmark'));}
launchToast('success',trans('Success'),result.message);}
else{launchToast('danger',trans('Error'),result.errors[0]);}},error:function(result){launchToast('danger',trans('Error'),result.responseJSON.message);}});},togglePostPin:function(id){let reactElement=$('*[data-postID="'+id+'"] .pin-button');const isPinned=reactElement.hasClass('is-active');$('.pinned-post-label').addClass('d-none');$.ajax({type:'POST',data:{'action':(isPinned===true?'remove':'add'),'id':id},dataType:'json',url:app.baseUrl+'/posts/pin',success:function(result){if(result.success){if(isPinned){$('*[data-postID="'+id+'"] .pinned-post-label').addClass('d-none');reactElement.removeClass('is-active');reactElement.html(trans('Pin this post'));}
else{$('*[data-postID="'+id+'"] .pinned-post-label').removeClass('d-none');reactElement.addClass('is-active');reactElement.html(trans('Un-pin post'));}
launchToast('success',trans('Success'),result.message);}
else{launchToast('danger',trans('Error'),result.errors[0]);}},error:function(result){launchToast('danger',trans('Error'),result.responseJSON.message);}});},disablePostsRightClick:function(){$(".post-media, .pswp__item").unbind('contextmenu');$(".post-media, .pswp__item").on("contextmenu",function(){return false;});bindNoLongPressEvents();},toggleFullDescription:function(postID){let postElement=$('*[data-postID="'+postID+'"]');$('*[data-postID="'+postID+'"] .label-less, *[data-postID="'+postID+'"] .label-more').addClass('d-none');if(postElement.find('.post-content-data').hasClass('line-clamp-3')){postElement.find('.post-content-data').removeClass('line-clamp-3');postElement.find('.label-less').removeClass('d-none');}
else{postElement.find('.post-content-data').addClass('line-clamp-3');postElement.find('.label-more').removeClass('d-none');}
PostsPaginator.scrollToLastPost(postID);},showEditCommentInterface:function(postID,commentID){Post.cancelEditCommentInterface();let commentElement=$('*[data-commentID="'+commentID+'"]');commentElement.find('.post-comment-content').addClass('d-none');commentElement.find('.post-comment-edit').removeClass('d-none');},cancelEditCommentInterface:function(){$('.post-comment').each(function(key,element){$(element).find('.post-comment-content').removeClass('d-none');$(element).find('.post-comment-edit').addClass('d-none');let commentElement=$(element);commentElement.find('.edit-comment-textarea').removeClass('is-invalid');let commentContent=commentElement.find('.comment-content').html();commentContent=filterXSS(commentContent);commentElement.find('textarea').val(commentContent);});},saveEditedComment:function(postID,commentID){let commentElement=$('*[data-commentID="'+commentID+'"]');let newCommentButton=commentElement.find('.post-comment-edit').find('button');let commentContent=commentElement.find('textarea').val();updateButtonState('loading',newCommentButton);$.ajax({type:'POST',data:{'message':commentContent,'post_id':postID,'comment_id':commentID},url:app.baseUrl+'/posts/comments/edit',success:function(result){if(result.success){launchToast('success',trans('Success'),trans('Comment saved'));commentContent=filterXSS(commentContent);commentElement.find('textarea').val(commentContent);commentElement.find('.comment-content').html(commentContent);Post.cancelEditCommentInterface();initTooltips();updateButtonState('loaded',newCommentButton);}
else{launchToast('danger',trans('Error'),result.errors[0]);updateButtonState('loaded',newCommentButton);}
newCommentButton.blur();},error:function(result){commentElement.find('textarea').addClass('is-invalid');if(result.status===422){$.each(result.responseJSON.errors,function(field,error){if(field==='message'){commentElement.find('textarea').parent().find('.invalid-feedback').html(error);}});updateButtonState('loaded',newCommentButton);}
else if(result.status===403||result.status===404){launchToast('danger',trans('Error'),result.responseJSON.message);}
newCommentButton.blur();}});},};"use strict";$(function(){$("#post-price").keypress(function(e){if(e.which===13){PostCreate.savePostPrice();}});});var PostCreate={postPrice:0,isSavingRedirect:false,postNotifications:false,postReleaseDate:null,postExpireDate:null,togglePostNotifications:function(){let buttonIcon='';if(PostCreate.postNotifications===true){PostCreate.postNotifications=false;buttonIcon=`<div class="d-flex justify-content-center align-items-center mr-1"><ion-icon class="icon-medium" name="notifications-off-outline"></ion-icon></div>`;}
else{buttonIcon=`<div class="d-flex justify-content-center align-items-center mr-1"><ion-icon class="icon-medium" name="notifications-outline"></ion-icon></div>`;PostCreate.postNotifications=true;}
$('.post-notification-icon').html(buttonIcon);},showSetPricePostDialog:function(){try{if(typeof $.fn!=='undefined'&&typeof $.fn.modal!=='undefined'){$('#post-set-price-dialog').modal('show');}else{console.log('Bootstrap modal not available, using fallback.');this.showModalFallback('#post-set-price-dialog');}}catch(e){console.error('Error showing price dialog:',e);this.showModalFallback('#post-set-price-dialog');}},showModalFallback:function(selector){var modal=document.querySelector(selector);if(modal){modal.style.display='block';modal.classList.add('show');document.body.classList.add('modal-open');if(!document.querySelector('.modal-backdrop')){var backdrop=document.createElement('div');backdrop.className='modal-backdrop fade show';document.body.appendChild(backdrop);}
var closeButtons=modal.querySelectorAll('[data-dismiss="modal"], .close');closeButtons.forEach(function(btn){btn.onclick=function(){PostCreate.hideModalFallback(selector);};});}},hideModalFallback:function(selector){var modal=document.querySelector(selector);if(modal){modal.style.display='none';modal.classList.remove('show');document.body.classList.remove('modal-open');var backdrop=document.querySelector('.modal-backdrop');if(backdrop){backdrop.parentNode.removeChild(backdrop);}}},savePostPrice:function(){PostCreate.postPrice=$('#post-price').val();let hasError=false;if(!passesMinMaxPPPostLimits(PostCreate.postPrice)){hasError='min';}
if(PostCreate.postExpireDate!==null){hasError='ppv';}
if(hasError){$('.post-price-error').addClass('d-none');$('#post-set-price-dialog .'+hasError+'-error').removeClass('d-none');$('#post-price').addClass('is-invalid');return false;}
$('.post-price-label').html('('+getWebsiteFormattedAmount(PostCreate.postPrice)+')');try{if(typeof $.fn!=='undefined'&&typeof $.fn.modal!=='undefined'){$('#post-set-price-dialog').modal('hide');}else{this.hideModalFallback('#post-set-price-dialog');}}catch(e){console.error('Error hiding price dialog:',e);this.hideModalFallback('#post-set-price-dialog');}
$('#post-price').removeClass('is-invalid');},clearPostPrice:function(){PostCreate.postPrice=0;$('#post-price').val(0);$('.post-price-label').html('');try{if(typeof $.fn!=='undefined'&&typeof $.fn.modal!=='undefined'){$('#post-set-price-dialog').modal('hide');}else{this.hideModalFallback('#post-set-price-dialog');}}catch(e){console.error('Error hiding price dialog:',e);this.hideModalFallback('#post-set-price-dialog');}
$('#post-price').removeClass('is-invalid');},initPostDraft:function(data,type='draft'){Post.initialDraftData=Post.draftData;if(data){Post.draftData=data;if(type==='draft'){FileUpload.attachaments=data.attachments;}
else{data.attachments.map(function(item){FileUpload.attachaments.push({attachmentID:item.id,path:item.path,type:item.attachmentType,thumbnail:item.thumbnail});});}
$('#dropzone-uploader').val(Post.draftData.text);}},clearDraft:function(){Post.draftData.attachments.map(function(value){FileUpload.removeAttachment(value.attachmentID);});$('.dropzone-previews .dz-preview ').each(function(index,item){$(item).remove();});FileUpload.attachaments=[];PostCreate.clearDraftData();},saveDraftData:function(){Post.draftData.attachments=FileUpload.attachaments;Post.draftData.text=$('#dropzone-uploader').val();localStorage.setItem('draftData',JSON.stringify(Post.draftData));},clearDraftData:function(callback=null){localStorage.removeItem('draftData');Post.draftData=Post.initialDraftData;if(callback!==null){callback;}
$('#dropzone-uploader').val(Post.draftData.text);},populateDraftData:function(){const draftData=localStorage.getItem('draftData');if(draftData){return JSON.parse(draftData);}
else{return false;}},save:function(type='create',postID=false,forceSave=false){if((FileUpload.isLoading===true||FileUpload.isTranscodingVideo===true)&&forceSave===false){let dialogMessage='';if(FileUpload.isLoading===true){dialogMessage=`${trans('Some attachments are still being uploaded.')} ${trans('Are you sure you want to continue?')}`;}
if(FileUpload.isTranscodingVideo===true){dialogMessage=`${trans('A video is currently being converted.')} ${trans('Are you sure you want to continue without it?')}`;}
$('#confirm-post-save .modal-body p').html(dialogMessage);$('.confirm-post-save').unbind('click');$('.confirm-post-save').on('click',function(){PostCreate.save(type,postID,true);});$('#confirm-post-save').modal('show');return false;}
updateButtonState('loading',$('.post-create-button'));PostCreate.savePostScheduleSettings();let route=app.baseUrl+'/posts/save';let data={'attachments':FileUpload.attachaments,'text':$('#dropzone-uploader').val(),'price':PostCreate.postPrice,'postNotifications':PostCreate.postNotifications,'postReleaseDate':PostCreate.postReleaseDate,'postExpireDate':PostCreate.postExpireDate};if(type==='create'){data.type='create';}
else{data.type='update';data.id=postID;}
$.ajax({type:'POST',data:data,url:route,success:function(){if(type==='create'){PostCreate.isSavingRedirect=true;PostCreate.clearDraftData(redirect(app.baseUrl+'/'+user.username));}
else{redirect(app.baseUrl+'/posts/'+postID+'/'+user.username);}
updateButtonState('loaded',$('.post-create-button'),trans('Save'));$('#confirm-post-save').modal('hide');},error:function(result){if(result.status===422||result.status===500){$.each(result.responseJSON.errors,function(field,error){if(field==='text'){$('.post-invalid-feedback').html(trans_choice('Your post must contain more than 10 characters.',mediaSettings.max_post_description_size,{'num':mediaSettings.max_post_description_size}));$('#dropzone-uploader').addClass('is-invalid');$('#dropzone-uploader').focus();}
if(field==='attachments'){$('.post-invalid-feedback').html(trans('Your post must contain at least one attachment.'));$('#dropzone-uploader').addClass('is-invalid');$('#dropzone-uploader').focus();}
if(field==='price'){$('.post-invalid-feedback').html(result.responseJSON.message);$('#dropzone-uploader').addClass('is-invalid');$('#dropzone-uploader').focus();}
if(field==='permissions'){launchToast('danger',trans('Error'),error);}});}
else if(result.status===403){launchToast('danger',trans('Error'),'Post not found.');}
$('#confirm-post-save').modal('hide');updateButtonState('loaded',$('.post-create-button'),trans('Save'));}});},showPostScheduleSettings:function(){try{if(typeof $.fn!=='undefined'&&$.fn.modal){$('#post-schedule-dialog').modal('show');}else{console.log('Bootstrap modal not available for scheduling, using fallback.');this.showModalFallback('#post-schedule-dialog');}}catch(e){console.error('Error showing schedule dialog:',e);this.showModalFallback('#post-schedule-dialog');}},savePostScheduleSettings:function(){PostCreate.postReleaseDate=null;PostCreate.postExpireDate=null;if($('#release-date-input').length>0&&$('#release-date-input').val().length>0){PostCreate.postReleaseDate=$('#release-date-input').val();if($('.release-date-preview').length>0){$('.release-date-preview').html(' • '+$('#release-date-input').val());}
if($('.release-date-clear').length>0&&$('.release-date-clear').hasClass('d-none')){$('.release-date-clear').removeClass('d-none');}}
else{if($('.release-date-preview').length>0){$('.release-date-preview').html('');}
if($('.release-date-clear').length>0&&!$('.release-date-clear').hasClass('d-none')){$('.release-date-clear').addClass('d-none');}}
if($('#expiry-date-input').length>0&&$('#expiry-date-input').val().length>0){PostCreate.postExpireDate=$('#expiry-date-input').val();if($('.expire-date-preview').length>0){$('.expire-date-preview').html(' • '+$('#expiry-date-input').val());}
if($('.expire-date-clear').length>0&&$('.expire-date-clear').hasClass('d-none')){$('.expire-date-clear').removeClass('d-none');}
if(PostCreate.postPrice>0){if($('#post-schedule-dialog').length>0){try{if(typeof $.fn!=='undefined'&&$.fn.modal){$('#post-schedule-dialog').modal('hide');}else{this.hideModalFallback('#post-schedule-dialog');}}catch(e){console.error('Error hiding schedule dialog:',e);}}
PostCreate.clearPostPrice();if(typeof launchToast==='function'){launchToast('danger',trans('Error'),trans('Posts having an expire date can not be price locked.'));}
return false;}}
else{if($('.expire-date-preview').length>0){$('.expire-date-preview').html('');}
if($('.expire-date-clear').length>0&&!$('.expire-date-clear').hasClass('d-none')){$('.expire-date-clear').addClass('d-none');}}
if($('#post-schedule-dialog').length>0){try{if(typeof $.fn!=='undefined'&&$.fn.modal){$('#post-schedule-dialog').modal('hide');}else{this.hideModalFallback('#post-schedule-dialog');}}catch(e){console.error('Error hiding schedule dialog:',e);this.hideModalFallback('#post-schedule-dialog');}}},clearReleaseDate:function(){$('#release-date-input').val('');$('.release-date-preview').html('');if(!$('.release-date-clear').hasClass('d-none')){$('.release-date-clear').addClass('d-none');}
PostCreate.postReleaseDate=null;},clearExpireDate:function(){$('#expiry-date-input').val('');$('.expire-date-preview').html('');if(!$('.expire-date-clear').hasClass('d-none')){$('.expire-date-clear').addClass('d-none');}
PostCreate.postExpireDate=null;},};"use strict";var AiSuggestions={targetedClass:null,suggestionType:null,initAISuggestions:function(selector,type){this.setTargetedClass(selector);this.setSuggestionType(type);AiSuggestions.setDefaultDescription(type);},suggestDescriptionDialog:function(){$('#suggest-description-dialog').modal('show');if(this.suggestionType==='stream'){$('#stream-update-dialog').modal('hide');}},setTargetedClass(className){this.targetedClass=className;},setSuggestionType(type){this.suggestionType=type;},saveSuggestion:function(){let description=$('#ai-request').val();let validDescription=this.validateDescription();if(validDescription){$('#ai-request').removeClass('is-invalid');$('#suggest-description-dialog').modal('hide');if(this.suggestionType==='profile'){if(app.allow_profile_bio_markdown){ProfileSettings.mdeEditor.value(description);}
else{$(this.targetedClass).val(description);}}
else{$(this.targetedClass).val(description);}
if(this.suggestionType==='stream'){$('#stream-update-dialog').modal('show');}
$('#ai-request').removeClass('is-invalid');}},clearSuggestion:function(){$('#ai-request').val('');},suggestDescription:function(){let validDescription=this.validateDescription();if(validDescription){$('#ai-request').removeClass('is-invalid');updateButtonState('loading',$('.suggest-description'),trans('Suggest'),'light');let route=app.baseUrl+'/suggestions/generate';let data={'text':$('#ai-request').val()+trans('Do not include any explanation.'),};$.ajax({type:'POST',data:data,url:route,success:function(response){if(response.message){$('#ai-request').val(response.message);}
updateButtonState('loaded',$('.suggest-description'),trans('Suggest'));},error:function(result){if(result.status===422||result.status===500){launchToast('danger',trans('Error'),result.responseJSON.message);}
else if(result.status===403){launchToast('danger',trans('Error'),'Something went wrong, please try again');}
updateButtonState('loaded',$('.suggest-description'),trans('Suggest'));}});}},validateDescription:function(){let description=$('#ai-request').val();if(description.length<5){$('#ai-request').addClass('is-invalid');return false;}
return true;},setDefaultDescription:function(type){let description;if(type==='post'){description=trans('Write me a short post description to post on my profile',{'siteName':app.siteName});}else if(type==='profile'){description=trans('Write me a short profile bio description',{'siteName':app.siteName});}
else if(type==='stream'){description=trans('Write me a shot stream title',{'siteName':app.siteName});}
if(description){$('#ai-request').val(description);}}};"use strict";if(typeof window.dropzoneInitialized==='undefined'){window.dropzoneInitialized=false;}
(function(){if(typeof jQuery==='undefined'){console.error("jQuery not loaded. FileUpload requires jQuery.");var script=document.createElement('script');script.src='https://code.jquery.com/jquery-3.6.0.min.js';script.integrity='sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=';script.crossOrigin='anonymous';document.head.appendChild(script);}
if(typeof jQuery!=='undefined'&&typeof $==='undefined'){window.$=window.jQuery;}})();if(typeof Dropzone==='undefined'){console.error("Dropzone not loaded. FileUpload requires Dropzone.");}
document.addEventListener('DOMContentLoaded',function(){if(typeof $!=='undefined'&&typeof Dropzone!=='undefined'){initializeFileUpload();}else{console.log("Dependencies not loaded yet, waiting...");setTimeout(function checkDependencies(){if(typeof $!=='undefined'&&typeof Dropzone!=='undefined'){initializeFileUpload();}else{console.log("Still waiting for dependencies...");setTimeout(checkDependencies,500);}},500);}});function initializeFileUpload(){if(window.dropzoneInitialized){console.log("Dropzone already initialized, skipping...");return;}
console.log("Initializing FileUpload module...");Dropzone.autoDiscover=false;window.dropzoneInitialized=true;}
var FileUpload={attachaments:[],myDropzone:null,isLoading:false,isTranscodingVideo:false,state:{},initDropZone:function(selector,url,isChunkUpload=false){console.log("FileUpload.initDropZone called with selector:",selector);if(typeof $==='undefined'){console.error("jQuery not available for FileUpload.initDropZone");return;}
if(typeof Dropzone==='undefined'){console.error("Dropzone not available for FileUpload.initDropZone");return;}
if(!$(selector).length){console.error("Target element not found:",selector);return;}
if(FileUpload.myDropzone!==null){console.log("FileUpload instance already exists, destroying old instance");try{FileUpload.myDropzone.destroy();}catch(e){console.error("Error destroying old Dropzone instance:",e);}}
let chunkSize=1024;if(isChunkUpload){chunkSize=mediaSettings.upload_chunk_size*1000000;url=url.replace('/upload/','/uploadChunked/');}
$(document).off('click','.file-upload-button').on('click','.file-upload-button',function(e){if(e.target===this||$(e.target).hasClass('file-button-text')||$(e.target).is('svg')||$(e.target).is('path')){console.log('File upload button clicked');if(typeof FileUpload!=='undefined'&&FileUpload.myDropzone){e.preventDefault();e.stopPropagation();FileUpload.myDropzone.hiddenFileInput.click();return false;}else{$('#direct-file-input').click();}}});if(typeof app==='undefined'||!app.baseUrl){console.error("app.baseUrl not defined");app=app||{};app.baseUrl='';}
const uploadUrl=app.baseUrl+url;console.log("Upload URL:",uploadUrl);try{FileUpload.myDropzone=new Dropzone(selector,{paramName:"file",url:uploadUrl,headers:{'X-CSRF-TOKEN':$('meta[name="csrf-token"]').attr('content')},clickable:true,previewsContainer:".dropzone-previews",maxFilesize:mediaSettings.max_file_upload_size,addRemoveLinks:true,dictRemoveFile:"x",acceptedFiles:mediaSettings.allowed_file_extensions,chunking:isChunkUpload,forceChunking:isChunkUpload,chunkSize:chunkSize,timeout:180000,retryChunks:false,retryChunksLimit:2,autoProcessQueue:true,init:function(){console.log("Dropzone initialized successfully");var self=this;if(FileUpload.attachaments&&FileUpload.attachaments.length){FileUpload.attachaments.forEach(function(element){if(element&&element.attachmentID){try{var mockFile={name:element.attachmentID,upload:{attachmentID:element.attachmentID},type:element.type,thumbnail:element.thumbnail};function safeEmit(event,...args){if(self&&typeof self.emit==='function'){self.emit(event,...args);}else{console.error("Cannot emit Dropzone event: "+event);}}
safeEmit("addedfile",mockFile);safeEmit("thumbnail",mockFile,element.thumbnail);safeEmit("complete",mockFile);FileUpload.updatePreviewElement(mockFile,false,element);}catch(e){console.error("Error adding existing file to Dropzone:",e);}}});}
$(".draft-clear-button").off('click').on("click",function(){if(FileUpload.myDropzone&&typeof FileUpload.myDropzone.removeAllFiles==='function'){FileUpload.myDropzone.removeAllFiles(true);}});$(document).off('click','.submit-button, .save-button').on('click','.submit-button, .save-button',function(e){if(FileUpload.isLoading){e.preventDefault();return launchToast('warning',trans('Please wait'),trans('Please wait for uploads to complete'));}
if(FileUpload.myDropzone&&FileUpload.myDropzone.getQueuedFiles().length>0){e.preventDefault();FileUpload.myDropzone.processQueue();FileUpload.myDropzone.on('queuecomplete',function(){setTimeout(function(){$(e.target).closest('form').submit();},500);});}});}});console.log("Dropzone setup complete");FileUpload.myDropzone.on("sending",function(){FileUpload.isLoading=true;});FileUpload.myDropzone.on("removedfile",function(file){if(file&&file.upload&&file.upload.attachmentID){FileUpload.removeAttachment(file.upload.attachmentID);}});FileUpload.myDropzone.on("complete",function(){FileUpload.isLoading=false;});FileUpload.myDropzone.on("success",function(file,response){if(response&&response.success){file.upload.attachmentID=response.attachmentID;console.log("File uploaded successfully:",response);FileUpload.attachaments.push({attachmentID:response.attachmentID,path:response.path,type:response.type,thumbnail:response.thumbnail||response.path});FileUpload.updatePreviewElement(file,response);if(typeof launchToast==='function'){launchToast('success',trans('Success'),trans('File uploaded successfully'));}}});FileUpload.myDropzone.on("error",function(file,errorMessage){console.error("Upload error:",errorMessage);if(typeof launchToast==='function'){launchToast('danger',trans('Error'),errorMessage);}else{alert("Upload error: "+errorMessage);}
FileUpload.myDropzone.removeFile(file);});return FileUpload.myDropzone;}catch(e){console.error("Error initializing Dropzone:",e);return null;}},updatePreviewElement:function(file,response=false,element=false){try{if(response){element=response;}
if(element){const type=element.type||'image';if(type.includes('image')){this.imagePreview(file,element);}else if(type.includes('video')){this.videoPreview(file,element);}else if(type.includes('audio')){this.audioPreview(file,element);}else if(type.includes('pdf')){this.pdfPreview(file,element);}else if(type.includes('spreadsheet')||type.includes('excel')){this.excelPreview(file,element);}
const previewElement=file.previewElement;if(previewElement){const priceBtn=document.createElement('span');priceBtn.className='post-price-button';priceBtn.innerHTML='<ion-icon name="pricetag-outline"></ion-icon>';priceBtn.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();if(typeof PostCreate!=='undefined'){PostCreate.showSetPricePostDialog();}});previewElement.appendChild(priceBtn);}}}catch(e){console.error("Error updating preview element:",e);}},setMediaSourceForPreviewByElementAndFile:function(element,file){if(typeof element==='undefined'){return false;}
if(element.canPlayType(file.type).length&&element.canPlayType(file.type)!=="no"){const fileURL=window.URL.createObjectURL(file);$(element).on('loadeddata',function(){window.URL.revokeObjectURL(fileURL);});$(element).attr('src',fileURL);$(element).attr('type',file.type);}
else{$(element).attr('src',app.baseUrl+'/img/video-loading-spinner.mp4');$(element).attr('loop',true);}},setPreviewSource:function(element,file,attachment){if(attachment.coconut_id!==null&&attachment.path.indexOf('videos/tmp/')>=0){$(element).attr('src',app.baseUrl+'/img/video-loading-spinner.mp4');}
else{$(element).attr('src',attachment.path);}},removeAttachment:function(attachmentID){$.ajax({type:'POST',data:{'attachmentId':attachmentID,},url:app.baseUrl+'/attachment/remove',success:function(){launchToast('success',trans('Success'),trans('Attachment removed.'));},error:function(){launchToast('danger',trans('Error'),trans('Failed to remove the attachment.'));}});},videoPreview:function(file,element){let filePreview=$(file.previewElement);filePreview.find('.dz-image').remove();filePreview.prepend(videoPreviewTemplate(file));var videoPreviewEl=filePreview.find('video').get(0);FileUpload.setMediaSourceForPreviewByElementAndFile(videoPreviewEl,file);},imagePreview:function(file,element){let filePreview=$(file.previewElement);filePreview.find('.dz-image').remove();filePreview.prepend(imagePreviewTemplate(file));if(!element){let previewElement=filePreview.find('img').get(0);FileUpload.setPreviewSource(previewElement,file,element);}},audioPreview:function(file,element){let filePreview=$(file.previewElement);filePreview.prepend(audioPreviewTemplate(file));filePreview.addClass("w-100");filePreview.find('audio').addClass("w-100");filePreview.find(".audio-preview-item").addClass("w-100");var audioPreviewEl=filePreview.find('audio').get(0);filePreview.addClass("w-100");FileUpload.setMediaSourceForPreviewByElementAndFile(audioPreviewEl,file);},pdfPreview:function(file,element){let filePreview=$(file.previewElement);filePreview.prepend(pdfPreviewTemplate(file));},excelPreview:function(file,element){let filePreview=$(file.previewElement);filePreview.prepend(excelPreviewTemplate(file));},};function videoPreviewTemplate(file){return'<div class="video-preview-item shadow"><video class="video-preview" controls autoplay muted loop></video></div>';}
function imagePreviewTemplate(file){return'<div class="dz-image shadow"><img src="'+(file.thumbnail||file.path)+'"/></div>';}
function audioPreviewTemplate(file){return'<div class="audio-preview-item shadow"><audio controls></audio></div>';}
function pdfPreviewTemplate(file){return'<div class="dz-image shadow"><img src="'+app.baseUrl+'/img/pdf-icon.png" style="max-width:64px;"/></div>';}
function excelPreviewTemplate(file){return'<div class="dz-image shadow"><img src="'+app.baseUrl+'/img/excel-icon.png" style="max-width:64px;"/></div>';}
$(document).ready(function(){$(document).off('click','.post-price-button').on('click','.post-price-button',function(e){if(typeof PostCreate!=='undefined'){e.preventDefault();e.stopPropagation();if(!$(this).hasClass('disabled')){PostCreate.showSetPricePostDialog();}
return false;}});});"use strict";(function(){if(typeof jQuery==='undefined'){console.error('jQuery not loaded in create.js. Attempting to load it.');var script=document.createElement('script');script.src='https://code.jquery.com/jquery-3.6.0.min.js';script.integrity='sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=';script.crossOrigin='anonymous';script.onload=function(){console.log('jQuery loaded successfully in create.js');initializeCreatePage();};document.head.appendChild(script);}else{$(document).ready(function(){initializeCreatePage();});}})();function initializeCreatePage(){if(document.readyState!=='loading'){setupCreatePage();}else{document.addEventListener('DOMContentLoaded',setupCreatePage);}}
function setupCreatePage(){console.log('Setting up post create page');$('.post-create-button').on('click',function(){PostCreate.save('create');});$('.draft-clear-button').on('click',function(){PostCreate.clearDraft();});const draftData=PostCreate.populateDraftData();PostCreate.initPostDraft(draftData);if(typeof isAllowedToPost!=='undefined'&&isAllowedToPost){if(typeof $==='undefined'||typeof Dropzone==='undefined'){console.error('Missing dependencies for file upload');}else{Dropzone.autoDiscover=false;if(typeof FileUpload!=='undefined'){FileUpload.initDropZone('#dropzone-uploader','/attachment/upload/post',false);}}
setupFileUploadButtons();setupPriceButton();}
if(typeof app!=='undefined'&&app.open_ai_enabled){if(typeof AiSuggestions!=='undefined'){AiSuggestions.initAISuggestions('#dropzone-uploader','post');}}}
function setupFileUploadButtons(){$(document).on('click','.file-upload-button',function(e){e.preventDefault();e.stopPropagation();if($(e.target).hasClass('file-upload-button')||$(e.target).parent().hasClass('file-upload-button')){if(typeof FileUpload!=='undefined'&&FileUpload.myDropzone){FileUpload.myDropzone.hiddenFileInput.click();}else{$('#direct-file-input').click();}}});$(document).on('click','#manual-upload-btn',function(e){e.preventDefault();$('#manual-file-input').click();});$(document).on('click','.file-upload-button *',function(e){e.stopPropagation();});}
function setupPriceButton(){$(document).on('click','.post-price-button',function(e){e.preventDefault();if(!$(this).hasClass('disabled')){PostCreate.showSetPricePostDialog();}});$("#post-price").on('keypress',function(e){if(e.which===13){PostCreate.savePostPrice();}});}
window.addEventListener('beforeunload',function(event){if(FileUpload.isTranscodingVideo===true||FileUpload.isLoading===true){event.returnValue=trans('Are you sure you want to leave?');}
if(!PostCreate.isSavingRedirect){PostCreate.saveDraftData();}});(function(){document.addEventListener('DOMContentLoaded',function(){if(typeof $==='undefined'){console.error('jQuery not available for attachment uploads');var script=document.createElement('script');script.src='https://code.jquery.com/jquery-3.6.0.min.js';script.onload=initUploads;document.head.appendChild(script);}else{initUploads();}});function initUploads(){$('.file-upload-button').on('click',function(e){if(typeof Dropzone==='undefined'||typeof FileUpload==='undefined'||FileUpload.myDropzone===null){e.preventDefault();e.stopPropagation();$('#direct-file-input').click();return false;}});$('#manual-upload-btn').on('click',function(e){e.preventDefault();$('#manual-file-input').click();});if($('#manual-file-input').length){$('#manual-file-input').on('click',function(e){e.stopPropagation();});}
if($('#direct-file-input').length){$('#direct-file-input').on('click',function(e){e.stopPropagation();});}
let dropzoneMonitorInterval=setInterval(function(){if(typeof Dropzone!=='undefined'){if(Dropzone.instances.length===0&&$('.dropzone').length>0){console.warn('Dropzone not initialized properly');$('.dropzone').addClass('dropzone-fallback');}else{clearInterval(dropzoneMonitorInterval);}}},2000);setTimeout(function(){clearInterval(dropzoneMonitorInterval);},10000);}})();